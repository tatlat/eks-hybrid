---
# This yaml provides samples for Secrets Store CSI static provisioning.
# Ref: https://secrets-store-csi-driver.sigs.k8s.io/getting-started/usage.html

apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: aws-secrets
  namespace: {{NAMESPACE}}
spec:
  provider: aws
  parameters:
    objects: |
      - objectName: "{{SECRET_NAME}}"
        objectType: "secretsmanager"
    usePodIdentity: "true"
    region: {{REGION}}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{SERVICE_ACCOUNT_NAME}}
  namespace: {{NAMESPACE}}
---
apiVersion: v1
kind: Pod
metadata:
  name: {{SECRETS_STORE_TEST_POD}}
  namespace: {{NAMESPACE}}
spec:
  serviceAccountName: {{SERVICE_ACCOUNT_NAME}}
  containers:
    - name: nginx
      image: "{{ECR_ACCOUNT_ID}}.dkr.ecr.{{REGION}}.amazonaws.com/ecr-public/nginx/nginx:latest"
      ports:
        - containerPort: 80
      volumeMounts:
        - name: secrets-store-inline
          mountPath: "/mnt/secrets-store"
          readOnly: true
  volumes:
    - name: secrets-store-inline
      csi:
        driver: secrets-store.csi.k8s.io
        readOnly: true
        volumeAttributes:
          secretProviderClass: "aws-secrets"
